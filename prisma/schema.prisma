generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model StocktakeSession {
  id            String         @id @default(cuid())
  name          String
  status        String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  stockChecks   StockCheck[]
  uploadedFiles UploadedFile[]

  @@index([createdAt])
  @@index([status])
  @@index([status, createdAt])
  @@map("stocktake_sessions")
}

model UploadedFile {
  id                 String            @id @default(cuid())
  filename           String
  uploadDate         DateTime          @default(now())
  location           String
  productCount       Int               @default(0)
  stocktakeSessionId String?
  products           Product[]
  stocktakeSession   StocktakeSession? @relation(fields: [stocktakeSessionId], references: [id], onDelete: Cascade)

  @@index([uploadDate])
  @@index([location])
  @@index([stocktakeSessionId])
  @@map("uploaded_files")
}

model Product {
  id          String       @id @default(cuid())
  fileId      String
  name        String
  sku         String?
  quantity    Int?
  price       Float?
  location    String?
  expectedQty Int?
  countedQty  Int?
  variance    Int?
  file        UploadedFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  stockChecks StockCheck[]

  @@index([sku])
  @@index([name])
  @@index([location])
  @@map("products")
}

model StockCheck {
  id          String           @id @default(cuid())
  productId   String
  sessionId   String
  expectedQty Int
  countedQty  Int
  variance    Int
  checkedAt   DateTime         @default(now())
  checkedBy   String?
  status      String
  product     Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  session     StocktakeSession @relation(fields: [sessionId], references: [id], onUpdate: NoAction)

  @@unique([productId, sessionId])
  @@index([sessionId])
  @@index([status])
  @@index([checkedAt])
  @@map("stock_checks")
}
